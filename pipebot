#!/usr/bin/env python

import os
import re
import select
import socket
import sys

HOST="irc.freenode.net"
PORT=6667
NICK="srpipebot"
IDENT="srpipebot"
REALNAME="srpipebot"
CHANNEL="#srobo-bots"
PIPE_PATH="/tmp/hash-srobo"
TARGET_BOT="srbot"

s=socket.socket()
s.connect((HOST, PORT))
s.setblocking(0)

s.send("NICK %s\r\n" % NICK)
s.send("USER %s %s bla :%s\r\n" % (IDENT, HOST, REALNAME))
s.send("JOIN %s\r\n" % CHANNEL)
s.send("PRIVMSG %s :%s\r\n" % (CHANNEL, "Ready to plumb.") )

if not os.path.exists(PIPE_PATH):
    os.mkfifo(PIPE_PATH)

irc_buf = ""
pipe_buf = ""

def privmsg(socket, target, msg):
    socket.send( "PRIVMSG %s :%s\r\n" % (target, msg) )
    pass

def open_fifo():
    fifofd = os.open( PIPE_PATH,
                      os.O_RDONLY | os.O_NONBLOCK )
    return fifofd

fifofd = open_fifo()

pass_fn = os.path.join(os.path.abspath(os.path.dirname(__file__)), "pass")
if os.path.exists(pass_fn):
    passfile = open(pass_fn, "r")
    privmsg( s, TARGET_BOT, "login pipebot %s" % (passfile.read().strip()) )
    passfile.close()

while True:
    ready = select.select( [fifofd,s], [], [fifofd] )

    if s in ready[0]:
        recv_data = s.recv(100)
        if len(recv_data) == 0:
            # Short read when select says data is available, means EOF.
            sys.stderr.write("Read EOF from irc server")
            # Don't reconnect automagically; init will restart us automatically,
            # with accounting.
            sys.exit(1)

        irc_buf += recv_data

        while "\n" in irc_buf:
            lp = irc_buf.find("\n")

            l = irc_buf[0:lp]
            irc_buf = irc_buf[lp+1:]

            print l
            if l[:4] == "PING":
                resp = l.replace( "I", "O", 1 )
                s.send( resp )
                continue

    if fifofd in ready[0]:
        d = os.read(fifofd, 100)
        if len(d) == 0:
            os.close(fifofd)
            fifofd = open_fifo()
            continue

        pipe_buf += d

        while "\n" in pipe_buf:
            nlpos = pipe_buf.find("\n")
            line = pipe_buf[0:nlpos]
            pipe_buf = pipe_buf[nlpos+1:]

            if re.match( "^[^ ]+: ping$", line ) == None:
                privmsg(s, CHANNEL, TARGET_BOT+": say #srobo %s" % line)
